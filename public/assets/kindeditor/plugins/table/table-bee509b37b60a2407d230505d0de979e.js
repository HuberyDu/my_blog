/*******************************************************************************
* KindEditor - WYSIWYG HTML Editor for Internet
* Copyright (C) 2006-2011 kindsoft.net
*
* @author Roddy <luolonghao@gmail.com>
* @site http://www.kindsoft.net/
* @licence http://www.kindsoft.net/license.php
*******************************************************************************/
KindEditor.plugin("table",function(e){function t(e,t){t=t.toUpperCase(),e.css("background-color",t),e.css("color","#000000"===t?"#FFFFFF":"#000000"),e.html(t)}function n(n,i){function a(){e.each(l,function(){this.remove()}),l=[],e(document).unbind("click,mousedown",a),n.unbind("click,mousedown",a)}i.bind("click,mousedown",function(e){e.stopPropagation()}),i.click(function(){a();var i=e(this),o=i.pos(),s=e.colorpicker({x:o.x,y:o.y+i.height(),z:811214,selectedColor:e(this).html(),colors:r.colorTable,noColor:r.lang("noColor"),shadowMode:r.shadowMode,click:function(e){t(i,e),a()}});l.push(s),e(document).bind("click,mousedown",a),n.bind("click,mousedown",a)})}function i(e,t,n){for(var i=0,r=0,a=t.cells.length;a>r&&t.cells[r]!=n;r++)i+=t.cells[r].rowSpan-1;return n.cellIndex-i}var r=this,a="table",o=r.lang(a+"."),s="ke-zeroborder",l=[];r.plugin.table={prop:function(i){var l=['<div style="padding:20px;">','<div class="ke-dialog-row">','<label for="keRows" style="width:90px;">'+o.cells+"</label>",o.rows+' <input type="text" id="keRows" class="ke-input-text ke-input-number" name="rows" value="" maxlength="4" /> &nbsp; ',o.cols+' <input type="text" class="ke-input-text ke-input-number" name="cols" value="" maxlength="4" />',"</div>",'<div class="ke-dialog-row">','<label for="keWidth" style="width:90px;">'+o.size+"</label>",o.width+' <input type="text" id="keWidth" class="ke-input-text ke-input-number" name="width" value="" maxlength="4" /> &nbsp; ','<select name="widthType">','<option value="%">'+o.percent+"</option>",'<option value="px">'+o.px+"</option>","</select> &nbsp; ",o.height+' <input type="text" class="ke-input-text ke-input-number" name="height" value="" maxlength="4" /> &nbsp; ','<select name="heightType">','<option value="%">'+o.percent+"</option>",'<option value="px">'+o.px+"</option>","</select>","</div>",'<div class="ke-dialog-row">','<label for="kePadding" style="width:90px;">'+o.space+"</label>",o.padding+' <input type="text" id="kePadding" class="ke-input-text ke-input-number" name="padding" value="" maxlength="4" /> &nbsp; ',o.spacing+' <input type="text" class="ke-input-text ke-input-number" name="spacing" value="" maxlength="4" />',"</div>",'<div class="ke-dialog-row">','<label for="keAlign" style="width:90px;">'+o.align+"</label>",'<select id="keAlign" name="align">','<option value="">'+o.alignDefault+"</option>",'<option value="left">'+o.alignLeft+"</option>",'<option value="center">'+o.alignCenter+"</option>",'<option value="right">'+o.alignRight+"</option>","</select>","</div>",'<div class="ke-dialog-row">','<label for="keBorder" style="width:90px;">'+o.border+"</label>",o.borderWidth+' <input type="text" id="keBorder" class="ke-input-text ke-input-number" name="border" value="" maxlength="4" /> &nbsp; ',o.borderColor+' <span class="ke-inline-block ke-input-color"></span>',"</div>",'<div class="ke-dialog-row">','<label for="keBgColor" style="width:90px;">'+o.backgroundColor+"</label>",'<span class="ke-inline-block ke-input-color"></span>',"</div>","</div>"].join(""),c=r.createDialog({name:a,width:500,title:r.lang(a),body:l,beforeRemove:function(){w.unbind()},yesBtn:{name:r.lang("yes"),click:function(){var t=d.val(),n=p.val(),i=h.val(),a=f.val(),o=m.val(),l=g.val(),c=v.val(),u=y.val(),C=b.val(),x=_.val(),T=e(w[0]).html()||"",E=e(w[1]).html()||"";if(0==t||!/^\d+$/.test(t))return alert(r.lang("invalidRows")),d[0].focus(),void 0;if(0==n||!/^\d+$/.test(n))return alert(r.lang("invalidRows")),p[0].focus(),void 0;if(!/^\d*$/.test(i))return alert(r.lang("invalidWidth")),h[0].focus(),void 0;if(!/^\d*$/.test(a))return alert(r.lang("invalidHeight")),f[0].focus(),void 0;if(!/^\d*$/.test(c))return alert(r.lang("invalidPadding")),v[0].focus(),void 0;if(!/^\d*$/.test(u))return alert(r.lang("invalidSpacing")),y[0].focus(),void 0;if(!/^\d*$/.test(x))return alert(r.lang("invalidBorder")),_[0].focus(),void 0;if(k)return""!==i?k.width(i+o):k.css("width",""),void 0!==k[0].width&&k.removeAttr("width"),""!==a?k.height(a+l):k.css("height",""),void 0!==k[0].height&&k.removeAttr("height"),k.css("background-color",E),void 0!==k[0].bgColor&&k.removeAttr("bgColor"),""!==c?k[0].cellPadding=c:k.removeAttr("cellPadding"),""!==u?k[0].cellSpacing=u:k.removeAttr("cellSpacing"),""!==C?k[0].align=C:k.removeAttr("align"),""!==x?k.attr("border",x):k.removeAttr("border"),""===x||"0"===x?k.addClass(s):k.removeClass(s),""!==T?k.attr("borderColor",T):k.removeAttr("borderColor"),r.hideDialog().focus(),void 0;var S="";""!==i&&(S+="width:"+i+o+";"),""!==a&&(S+="height:"+a+l+";"),""!==E&&(S+="background-color:"+E+";");var A="<table";""!==S&&(A+=' style="'+S+'"'),""!==c&&(A+=' cellpadding="'+c+'"'),""!==u&&(A+=' cellspacing="'+u+'"'),""!==C&&(A+=' align="'+C+'"'),""!==x&&(A+=' border="'+x+'"'),(""===x||"0"===x)&&(A+=' class="'+s+'"'),""!==T&&(A+=' bordercolor="'+T+'"'),A+=">";for(var N=0;t>N;N++){A+="<tr>";for(var D=0;n>D;D++)A+="<td>"+(e.IE?"&nbsp;":"<br />")+"</td>";A+="</tr>"}A+="</table>",e.IE||(A+="<br />"),r.insertHtml(A),r.select().hideDialog().focus(),r.addBookmark()}}}),u=c.div,d=e('[name="rows"]',u).val(3),p=e('[name="cols"]',u).val(2),h=e('[name="width"]',u).val(100),f=e('[name="height"]',u),m=e('[name="widthType"]',u),g=e('[name="heightType"]',u),v=e('[name="padding"]',u).val(2),y=e('[name="spacing"]',u).val(0),b=e('[name="align"]',u),_=e('[name="border"]',u).val(1),w=e(".ke-input-color",u);n(u,w.eq(0)),n(u,w.eq(1)),t(w.eq(0),"#000000"),t(w.eq(1),""),d[0].focus(),d[0].select();var k;if(!i&&(k=r.plugin.getSelectedTable())){d.val(k[0].rows.length),p.val(k[0].rows.length>0?k[0].rows[0].cells.length:0),d.attr("disabled",!0),p.attr("disabled",!0);var C,x=k[0].style.width||k[0].width,T=k[0].style.height||k[0].height;void 0!==x&&(C=/^(\d+)((?:px|%)*)$/.exec(x))?(h.val(C[1]),m.val(C[2])):h.val(""),void 0!==T&&(C=/^(\d+)((?:px|%)*)$/.exec(T))&&(f.val(C[1]),g.val(C[2])),v.val(k[0].cellPadding||""),y.val(k[0].cellSpacing||""),b.val(k[0].align||""),_.val(void 0===k[0].border?"":k[0].border),t(w.eq(0),e.toHex(k.attr("borderColor")||"")),t(w.eq(1),e.toHex(k[0].style.backgroundColor||k[0].bgColor||"")),h[0].focus(),h[0].select()}},cellprop:function(){var i=['<div style="padding:20px;">','<div class="ke-dialog-row">','<label for="keWidth" style="width:90px;">'+o.size+"</label>",o.width+' <input type="text" id="keWidth" class="ke-input-text ke-input-number" name="width" value="" maxlength="4" /> &nbsp; ','<select name="widthType">','<option value="%">'+o.percent+"</option>",'<option value="px">'+o.px+"</option>","</select> &nbsp; ",o.height+' <input type="text" class="ke-input-text ke-input-number" name="height" value="" maxlength="4" /> &nbsp; ','<select name="heightType">','<option value="%">'+o.percent+"</option>",'<option value="px">'+o.px+"</option>","</select>","</div>",'<div class="ke-dialog-row">','<label for="keAlign" style="width:90px;">'+o.align+"</label>",o.textAlign+' <select id="keAlign" name="textAlign">','<option value="">'+o.alignDefault+"</option>",'<option value="left">'+o.alignLeft+"</option>",'<option value="center">'+o.alignCenter+"</option>",'<option value="right">'+o.alignRight+"</option>","</select> ",o.verticalAlign+' <select name="verticalAlign">','<option value="">'+o.alignDefault+"</option>",'<option value="top">'+o.alignTop+"</option>",'<option value="middle">'+o.alignMiddle+"</option>",'<option value="bottom">'+o.alignBottom+"</option>",'<option value="baseline">'+o.alignBaseline+"</option>","</select>","</div>",'<div class="ke-dialog-row">','<label for="keBorder" style="width:90px;">'+o.border+"</label>",o.borderWidth+' <input type="text" id="keBorder" class="ke-input-text ke-input-number" name="border" value="" maxlength="4" /> &nbsp; ',o.borderColor+' <span class="ke-inline-block ke-input-color"></span>',"</div>",'<div class="ke-dialog-row">','<label for="keBgColor" style="width:90px;">'+o.backgroundColor+"</label>",'<span class="ke-inline-block ke-input-color"></span>',"</div>","</div>"].join(""),s=r.createDialog({name:a,width:500,title:r.lang("tablecell"),body:i,beforeRemove:function(){y.unbind()},yesBtn:{name:r.lang("yes"),click:function(){var t=c.val(),n=u.val(),i=d.val(),a=p.val(),o=(h.val(),f.val(),m.val()),s=g.val(),l=v.val(),b=e(y[0]).html()||"",w=e(y[1]).html()||"";return/^\d*$/.test(t)?/^\d*$/.test(n)?/^\d*$/.test(l)?(_.css({width:""!==t?t+i:"",height:""!==n?n+a:"","background-color":w,"text-align":o,"vertical-align":s,"border-width":l,"border-style":""!==l?"solid":"","border-color":b}),r.hideDialog().focus(),r.addBookmark(),void 0):(alert(r.lang("invalidBorder")),v[0].focus(),void 0):(alert(r.lang("invalidHeight")),u[0].focus(),void 0):(alert(r.lang("invalidWidth")),c[0].focus(),void 0)}}}),l=s.div,c=e('[name="width"]',l).val(100),u=e('[name="height"]',l),d=e('[name="widthType"]',l),p=e('[name="heightType"]',l),h=e('[name="padding"]',l).val(2),f=e('[name="spacing"]',l).val(0),m=e('[name="textAlign"]',l),g=e('[name="verticalAlign"]',l),v=e('[name="border"]',l).val(1),y=e(".ke-input-color",l);n(l,y.eq(0)),n(l,y.eq(1)),t(y.eq(0),"#000000"),t(y.eq(1),""),c[0].focus(),c[0].select();var b,_=r.plugin.getSelectedCell(),w=_[0].style.width||_[0].width||"",k=_[0].style.height||_[0].height||"";(b=/^(\d+)((?:px|%)*)$/.exec(w))?(c.val(b[1]),d.val(b[2])):c.val(""),(b=/^(\d+)((?:px|%)*)$/.exec(k))&&(u.val(b[1]),p.val(b[2])),m.val(_[0].style.textAlign||""),g.val(_[0].style.verticalAlign||"");var C=_[0].style.borderWidth||"";C&&(C=parseInt(C)),v.val(C),t(y.eq(0),e.toHex(_[0].style.borderColor||"")),t(y.eq(1),e.toHex(_[0].style.backgroundColor||"")),c[0].focus(),c[0].select()},insert:function(){this.prop(!0)},"delete":function(){var e=r.plugin.getSelectedTable();r.cmd.range.setStartBefore(e[0]).collapse(!0),r.cmd.select(),e.remove(),r.addBookmark()},colinsert:function(t){var n=r.plugin.getSelectedTable()[0],a=r.plugin.getSelectedRow()[0],o=r.plugin.getSelectedCell()[0],s=o.cellIndex+t;s+=n.rows[0].cells.length-a.cells.length;for(var l=0,c=n.rows.length;c>l;l++){var u=n.rows[l],d=u.insertCell(s);d.innerHTML=e.IE?"":"<br />",s=i(n,u,d)}r.cmd.range.selectNodeContents(o).collapse(!0),r.cmd.select(),r.addBookmark()},colinsertleft:function(){this.colinsert(0)},colinsertright:function(){this.colinsert(1)},rowinsert:function(t){var n=r.plugin.getSelectedTable()[0],i=r.plugin.getSelectedRow()[0],a=r.plugin.getSelectedCell()[0],o=i.rowIndex;1===t&&(o=i.rowIndex+(a.rowSpan-1)+t);for(var s=n.insertRow(o),l=0,c=i.cells.length;c>l;l++){i.cells[l].rowSpan>1&&(c-=i.cells[l].rowSpan-1);var u=s.insertCell(l);1===t&&i.cells[l].colSpan>1&&(u.colSpan=i.cells[l].colSpan),u.innerHTML=e.IE?"":"<br />"}for(var d=o;d>=0;d--){var p=n.rows[d].cells;if(p.length>l){for(var h=a.cellIndex;h>=0;h--)p[h].rowSpan>1&&(p[h].rowSpan+=1);break}}r.cmd.range.selectNodeContents(a).collapse(!0),r.cmd.select(),r.addBookmark()},rowinsertabove:function(){this.rowinsert(0)},rowinsertbelow:function(){this.rowinsert(1)},rowmerge:function(){var e=r.plugin.getSelectedTable()[0],t=r.plugin.getSelectedRow()[0],n=r.plugin.getSelectedCell()[0],i=t.rowIndex,a=i+n.rowSpan,o=e.rows[a];if(!(e.rows.length<=a)){var s=n.cellIndex;if(!(o.cells.length<=s)){var l=o.cells[s];n.colSpan===l.colSpan&&(n.rowSpan+=l.rowSpan,o.deleteCell(s),r.cmd.range.selectNodeContents(n).collapse(!0),r.cmd.select(),r.addBookmark())}}},colmerge:function(){var e=(r.plugin.getSelectedTable()[0],r.plugin.getSelectedRow()[0]),t=r.plugin.getSelectedCell()[0],n=(e.rowIndex,t.cellIndex),i=n+1;if(!(e.cells.length<=i)){var a=e.cells[i];t.rowSpan===a.rowSpan&&(t.colSpan+=a.colSpan,e.deleteCell(i),r.cmd.range.selectNodeContents(t).collapse(!0),r.cmd.select(),r.addBookmark())}},rowsplit:function(){var t=r.plugin.getSelectedTable()[0],n=r.plugin.getSelectedRow()[0],a=r.plugin.getSelectedCell()[0],o=n.rowIndex;if(1!==a.rowSpan){for(var s=i(t,n,a),l=1,c=a.rowSpan;c>l;l++){var u=t.rows[o+l],d=u.insertCell(s);a.colSpan>1&&(d.colSpan=a.colSpan),d.innerHTML=e.IE?"":"<br />",s=i(t,u,d)}e(a).removeAttr("rowSpan"),r.cmd.range.selectNodeContents(a).collapse(!0),r.cmd.select(),r.addBookmark()}},colsplit:function(){var t=(r.plugin.getSelectedTable()[0],r.plugin.getSelectedRow()[0]),n=r.plugin.getSelectedCell()[0],i=n.cellIndex;if(1!==n.colSpan){for(var a=1,o=n.colSpan;o>a;a++){var s=t.insertCell(i+a);n.rowSpan>1&&(s.rowSpan=n.rowSpan),s.innerHTML=e.IE?"":"<br />"}e(n).removeAttr("colSpan"),r.cmd.range.selectNodeContents(n).collapse(!0),r.cmd.select(),r.addBookmark()}},coldelete:function(){for(var t=r.plugin.getSelectedTable()[0],n=r.plugin.getSelectedRow()[0],i=r.plugin.getSelectedCell()[0],a=i.cellIndex,o=0,s=t.rows.length;s>o;o++){var l=t.rows[o],c=l.cells[a];c.colSpan>1?(c.colSpan-=1,1===c.colSpan&&e(c).removeAttr("colSpan")):l.deleteCell(a),c.rowSpan>1&&(o+=c.rowSpan-1)}0===n.cells.length?(r.cmd.range.setStartBefore(t).collapse(!0),r.cmd.select(),e(t).remove()):r.cmd.selection(!0),r.addBookmark()},rowdelete:function(){for(var t=r.plugin.getSelectedTable()[0],n=r.plugin.getSelectedRow()[0],i=r.plugin.getSelectedCell()[0],a=n.rowIndex,o=i.rowSpan-1;o>=0;o--)t.deleteRow(a+o);0===t.rows.length?(r.cmd.range.setStartBefore(t).collapse(!0),r.cmd.select(),e(t).remove()):r.cmd.selection(!0),r.addBookmark()}},r.clickToolbar(a,r.plugin.table.prop)});