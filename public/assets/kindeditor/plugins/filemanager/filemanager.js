/*******************************************************************************
* KindEditor - WYSIWYG HTML Editor for Internet
* Copyright (C) 2006-2011 kindsoft.net
*
* @author Roddy <luolonghao@gmail.com>
* @site http://www.kindsoft.net/
* @licence http://www.kindsoft.net/license.php
*******************************************************************************/
KindEditor.plugin("filemanager",function(e){function t(e,t,n){return e+" ("+Math.ceil(t/1024)+"KB, "+n+")"}function n(e,n){n.is_dir?e.attr("title",n.filename):e.attr("title",t(n.filename,n.filesize,n.datetime))}var i=this,r="filemanager",a=e.undef(i.fileManagerJson,i.basePath+"php/file_manager_json.php"),o=i.pluginsPath+r+"/images/",s=i.lang(r+".");i.plugin.filemanagerDialog=function(t){function l(t,n,r){var o="path="+t+"&order="+n+"&dir="+m;_.showLoading(i.lang("ajaxLoading")),e.ajax(e.addParam(a,o+"&"+(new Date).getTime()),function(e){_.hideLoading(),r(e)})}function c(t,n,i,r){var a=e.formatUrl(n.current_url+i.filename,"absolute"),o=encodeURIComponent(n.current_dir_path+i.filename+"/");i.is_dir?t.click(function(){l(o,x.val(),r)}):i.is_photo?t.click(function(){v.call(this,a,i.filename)}):t.click(function(){v.call(this,a,i.filename)}),T.push(t)}function d(t,n){function i(){"VIEW"==C.val()?l(t.current_dir_path,x.val(),f):l(t.current_dir_path,x.val(),u)}e.each(T,function(){this.unbind()}),k.unbind(),C.unbind(),x.unbind(),t.current_dir_path&&k.click(function(){l(t.moveup_dir_path,x.val(),n)}),C.change(i),x.change(i),w.html("")}function u(t){d(t,u);var n=document.createElement("table");n.className="ke-table",n.cellPadding=0,n.cellSpacing=0,n.border=0,w.append(n);for(var i=t.file_list,r=0,a=i.length;a>r;r++){var l=i[r],f=e(n.insertRow(r));f.mouseover(function(){e(this).addClass("ke-on")}).mouseout(function(){e(this).removeClass("ke-on")});var h=o+(l.is_dir?"folder-16.gif":"file-16.gif"),p=e('<img src="'+h+'" width="16" height="16" alt="'+l.filename+'" align="absmiddle" />'),m=e(f[0].insertCell(0)).addClass("ke-cell ke-name").append(p).append(document.createTextNode(" "+l.filename));!l.is_dir||l.has_file?(f.css("cursor","pointer"),m.attr("title",l.filename),c(m,t,l,u)):m.attr("title",s.emptyFolder),e(f[0].insertCell(1)).addClass("ke-cell ke-size").html(l.is_dir?"-":Math.ceil(l.filesize/1024)+"KB"),e(f[0].insertCell(2)).addClass("ke-cell ke-datetime").html(l.datetime)}}function f(t){d(t,f);for(var i=t.file_list,r=0,a=i.length;a>r;r++){var l=i[r],u=e('<div class="ke-inline-block ke-item"></div>');w.append(u);var h=e('<div class="ke-inline-block ke-photo"></div>').mouseover(function(){e(this).addClass("ke-on")}).mouseout(function(){e(this).removeClass("ke-on")});u.append(h);var p=t.current_url+l.filename,m=l.is_dir?o+"folder-64.gif":l.is_photo?p:o+"file-64.gif",g=e('<img src="'+m+'" width="80" height="80" alt="'+l.filename+'" />');!l.is_dir||l.has_file?(h.css("cursor","pointer"),n(h,l),c(h,t,l,f)):h.attr("title",s.emptyFolder),h.append(g),u.append('<div class="ke-name" title="'+l.filename+'">'+l.filename+"</div>")}}var h=e.undef(t.width,650),p=e.undef(t.height,510),m=e.undef(t.dirName,""),g=e.undef(t.viewType,"VIEW").toUpperCase(),v=t.clickFn,b=['<div style="padding:10px 20px;">','<div class="ke-plugin-filemanager-header">','<div class="ke-left">','<img class="ke-inline-block" name="moveupImg" src="'+o+'go-up.gif" width="16" height="16" border="0" alt="" /> ','<a class="ke-inline-block" name="moveupLink" href="javascript:;">'+s.moveup+"</a>","</div>",'<div class="ke-right">',s.viewType+' <select class="ke-inline-block" name="viewType">','<option value="VIEW">'+s.viewImage+"</option>",'<option value="LIST">'+s.listImage+"</option>","</select> ",s.orderType+' <select class="ke-inline-block" name="orderType">','<option value="NAME">'+s.fileName+"</option>",'<option value="SIZE">'+s.fileSize+"</option>",'<option value="TYPE">'+s.fileType+"</option>","</select>","</div>",'<div class="ke-clearfix"></div>',"</div>",'<div class="ke-plugin-filemanager-body"></div>',"</div>"].join(""),_=i.createDialog({name:r,width:h,height:p,title:i.lang(r),body:b}),y=_.div,w=e(".ke-plugin-filemanager-body",y),k=(e('[name="moveupImg"]',y),e('[name="moveupLink"]',y)),C=(e('[name="viewServer"]',y),e('[name="viewType"]',y)),x=e('[name="orderType"]',y),T=[];return C.val(g),l("",x.val(),"VIEW"==g?f:u),_}});